### 开发过程中遇到的主要问题

##### 1 响应式问题
问题描述：当游戏宽高发生改变，其他东西也要发生改变，比如字体大小、对话框大小、选项框大小、对话框的位置、选项框的位置等等

解决办法：建立映射关系，当游戏宽高发生改变会影响的参数，都设置为f(w,h)这类的二元函数（w为游戏宽度，h为游戏高度），这样一改皆改

##### 2 鼠标移动至选项的问题
问题描述：假设有若干选项，分别叫A、B、C...，当鼠标移动到A选项时，A高亮，其他选项不变，因为选项个数不固定，故用for循环来绘制，当鼠标移动到A选项时，改变画笔颜色，因为用for循环，导致所有的选项都高亮了

解决办法：建立一个枚举，作为选项们的状态机，这样每一个选项都有自己的状态，形如isMove[1,0,0,0]，这就表示A选项要高亮，而其他选项不要，在for循环中，通过判断这个isMove来决定何时更改画笔的颜色（原本“改变画布颜色”在for循环外）

##### 3 鼠标在空白处点击却导致按钮事件
问题描述：由于对每个按钮都赋予鼠标事件，代码过于冗杂，所以直接监听鼠标事件，然后判断鼠标的位置在不在按钮上，如果在，则触发按钮事件并把isClick改为false（清空鼠标点击状态），但是这样却导致鼠标在按钮外点击后，再移至按钮上，也会触发

解决办法：用mouseDown来代替click，当mouseUp时清空鼠标按下状态，这样的话，除非是在按钮外按下后不放，再拖动至按钮上

##### 4 Chrome上的音乐播放问题
问题描述：由于Chrome66的更新，使得audio不能在用户尚未与网页进行交互的情况下，播放音乐

解决办法：监听鼠标事件，当用户在网页内点击时，开启音乐功能（可以给予一定的视觉提示，如文字“点击唤醒游戏”）

##### 5 BGM切换问题
问题描述：由于程序依帧执行，直接播放音乐，导致播放不了（不断刷新），所以设置了一个状态量来控制音乐只播放一次，但是这样又导致音乐不能切换

解决办法：判断音乐源的路径，如果不同，则重置那个控制播放的状态量

##### 6 按钮事件的触发频率问题
问题描述：假设当玩家按下w键，角色会往上移动，因为不同电脑的输入效率不同，导致同样时一直按着w不松手，有的玩家会移动的更快

解决办法：设置状态机，当w键被按下时，对应的状态灯亮起（key['w'] = true），然后设置游戏帧率，有定时器来触发（判断状态，如果为true，则触发对应事件），为此还需要一个存放事件的json

##### 7 动画之间互相干扰
问题描述：假设有一个小球，我们要它往左移动，即x=x+speed1，给一个结束条件，当x>Max1时停止动画，假设我们还要它往下走，即y=y+speed2，也给一个结束条件，当y>Max2时停止动画，假设两个效果一起，那么就是往左下走，于是就会出现这种情况，x>Max1但y<Max2，即往左走已经到头，往下走还没有，但是此时动画已经停止了
（这个问题还会复杂化，比如有n个小球，某个小球停止，导致所有小球停止）

解决办法：不管几个小球，以动画为单位，为每一个动画设置一个状态量，合成一个状态机，如isEnd{'a':true, 'b':false, ...}，通过判断状态机上对应的状态量，从而停止对应的动画函数（其实不是真的停止，只是置空）
（状态机上的键目前是由用户给，由于是帧动画，每一帧都在执行动画函数，所以不便系统自动给出）

##### 8 颜色变化动画不同起点导致的等待问题
问题描述：颜色变化就是颜色码的变化，如rgba(0,0,0,0)到rgba(255,255,255,1)，如果我们把rgba中每一个颜色码看作是一个径赛运动员，由于存在不同运动员起跑线不同，或终点线不同，导致有的运动员到终点了，有的还没到（虽然现实生活中起点终点是相同的，但是运动员的速度是不同的，结果一样），如rgba(100,0,0,1)到rgba(255,255,255,1)，这个问题如同**7 动画之间互相干扰**一致，故由三种情况：①但凡有一个到终点，全体往回跑；②先到终点者先往回跑；③先到终点者等待，等全员都到终点了，再往回跑；我们要的是③（①和②在**7 动画之间互相干扰**已经体现并解决了）

解决办法：一样是给状态量，或者我们叫信号量（OS这门课里更爱这么叫），用这些信号量来表示谁到终点了，从而判断当大家都到终点时，一起往回跑，同理，在往回跑的过程中，也用信号量来判断谁到终点了（注意两类型号量的名称要不同，哎，命名空间的问题），比如我们给第一类型号量们当作一个状态机叫isEndR[0,1,0,0]，表示第二个运动员到达终点了，同理，第二类型号量的状态机叫isEndBR[1,0,0,0]，表示在往回跑上第一个运动员到达终点了

##### 9 文字动画逐行逐字输出问题
问题描述：通过for(i=0;i<line;i++)和for(j=0;j<word;j++)来输出文字，其中i表示第几行，j表示第几个字，通过word++控制word来控制输出的字数，从而到达一个字一个字往外蹦的效果，通过line++控制line来控制输出的行数，但是这里存在一个问题，就是当word达到一行的字数上限时，line++，表示可以输出第二行了，但是在输出第二行的时候，word已经达到上限了，所以会导致第二行整行输出。第三行第四行同理

解决办法：把word设为一个数组，word[i]表示第i行要输出的字数，这样当第一行输完，准备输第二行时，状态量为word[0]变成了word[1]，相当于重置了，也就不会出现干扰的问题（第二行整行输出），但是由于js中数组默认为Nan，所以要初始化word[i]（只要一次），还有就是line也要初始化，由于word[0]达到上限，所以文字动画函数的每次执行line都会++
（简而言之，就是把word拆成word[]，即给每行字数都赋予状态量）

##### 10 选项的冗杂问题
问题描述：不管是影响剧情的分支事件的选项还是游戏菜单的选项或者其他的选项等等，都需要hover（鼠标移动到区域内）改变颜色，需要click（鼠标点击）事件，需要在绘制框完成后改回文字颜色，在**2 鼠标移动至选项的问题**（这个是剧情的选项）中提到会用isMove[]这个状态机，这就导致这块的代码冗杂，需要不断地调用鼠标事件来更改状态或触发别的回调函数

解决办法：添加精灵机制，在大多数的2d游戏引擎中，都有精灵这个玩意，大致的意思是划定一个区域，在这个区域范围内有事件交互，由于我们目前仅支持AVG，所以需求比较简单，故精灵中的事件只有hover和click，把选项中冗杂的代码封装到精灵中，并返回hover状态以及触发回调函数

##### 11 拖拽事件的冲突问题
问题描述：拖拽事件采用的原理是先通过move事件判断鼠标是否移动到对象内，再通过dowm事件判断鼠标是否按下，如果move和down都为真，则触发回调函数，最后通过up事件判断鼠标是否抬起（若抬起则down为假，回调函数就不被触发），但是存在一个问题，设有A、B两个对象都可以拖拽，鼠标移到A上，此时move为真，鼠标按下，此时down为真则导致A和B的回调函数都被触发

解决办法：一开始是想设置状态量（惯用手段），后来改用初始化状态的办法，即在触发回调函数后，把move设为假，由于drag(A)和drag(b)在代码上存在先后关系，故当drag(A)中的回调函数被执行后，move为假，drag(b)中的move事件判断失败，故不触发b的回调函数，反之同理

##### 12 存档与读档问题
问题描述：档案结构要如何设计才能即保留玩家完整信息（游戏进度、存档时间等等）又与存储方式相匹配（由于网页不能绕过服务器和文件系统交互，所以单机页游只能采用localStorage的方式），其次存档和读档存在相关性，当玩家存档后，读档列表就会多一个，玩家才能读这个档，所以每次存档/读档前都要判断当前档案的情况，从而遍历出来

解决办法：用数组套JSON的方式来设计档案结构，即[{now: 1, time: 2019-12-24}, {now: 4, hp: 2019-12-25}]表示有两个档案，第一个游戏进度为1，存档时间为2019-12-24，第二个游戏进度为4，存档时间为2019-12-25，再把这个JSON转为String存入对应的localStorage.resume[i]中（这个resume是套JSON的数组，相当于档案袋，里面存了一堆档案）；存档/读档前要先遍历整个档案袋，存在一个问题，就是从来都没有存过档的情况，此时选择存档或读档，就会报错，因为localStorage.resume = null（档案袋未定义），所以要通过if判断来做初始化，注意不能直接初始化为[]或者''，而是要初始化为String类型的Array，即'[]'